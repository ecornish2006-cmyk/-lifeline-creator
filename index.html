<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life-Line Creator - Intention by Design</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #f3e8ff 50%, #fce7f3 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(to right, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #4b5563;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .description {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .main-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-blue { background: #dbeafe; color: #1d4ed8; }
        .btn-blue:hover:not(:disabled) { background: #bfdbfe; }
        .btn-red { background: #fee2e2; color: #dc2626; }
        .btn-red:hover:not(:disabled) { background: #fecaca; }
        .btn-gray { background: #f3f4f6; color: #374151; }
        .btn-gray:hover:not(:disabled) { background: #e5e7eb; }
        .btn-green { background: #dcfce7; color: #16a34a; }
        .btn-green:hover:not(:disabled) { background: #bbf7d0; }

        .content-area {
            display: flex;
        }

        .sidebar {
            width: 256px;
            background: #f9fafb;
            padding: 1rem;
            border-right: 1px solid #e5e7eb;
        }

        .sidebar-section {
            margin-bottom: 1rem;
        }

        .sidebar-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .tool-btn {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #4b5563;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .tool-btn:hover:not(.active) {
            background: #f3f4f6;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .color-btn {
            width: 3rem;
            height: 3rem;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-btn.active {
            transform: scale(1.1);
            border-color: #6b7280;
        }

        .color-btn:hover {
            transform: scale(1.05);
        }

        .canvas-area {
            flex: 1;
            padding: 1rem;
        }

        .canvas-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .canvas-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .canvas-description {
            font-size: 0.875rem;
            color: #4b5563;
        }

        .canvas-container {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            overflow: hidden;
        }

        #lifelineCanvas {
            display: block;
            width: 100%;
            height: auto;
            background: white;
        }

        .canvas-footer {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .selected-controls {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 0.75rem;
        }

        .selected-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .size-controls {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .size-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 4px;
            border: 1px solid #bfdbfe;
            background: white;
            color: #1d4ed8;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .size-btn.active {
            background: #3b82f6;
            color: white;
        }

        .size-btn:hover:not(.active) {
            background: #dbeafe;
        }

        .control-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .instructions {
            font-size: 0.75rem;
            color: #4b5563;
            line-height: 1.4;
        }

        .instructions strong {
            color: #1f2937;
        }

        .selected-instruction {
            color: #1d4ed8;
            font-weight: 500;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 32rem;
            width: 90%;
            margin: 1rem;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .style-btn {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #f9fafb;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .style-btn.active {
            background: #dbeafe;
            border-color: #bfdbfe;
        }

        .style-btn:hover:not(.active) {
            background: #f3f4f6;
        }

        .style-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .style-icon {
            font-size: 1.125rem;
        }

        .style-name {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .style-description {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn-cancel:hover {
            background: #e5e7eb;
        }

        .modal-btn-confirm {
            background: #3b82f6;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #2563eb;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .content-area {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .toolbar-left, .toolbar-right {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Life-Line Creator</h1>
            <p class="subtitle">From "Intention by Design" - Volume 1: Designing Your Life-Line</p>
            <p class="description">Create an interactive visualization of your unique life journey</p>
        </div>

        <div class="main-container">
            <div class="toolbar">
                <div class="toolbar-left">
                    <button id="undoBtn" class="btn btn-blue" disabled>
                        <span>↶</span> Undo (<span id="undoCount">0</span>)
                    </button>
                    <button id="clearBtn" class="btn btn-red">
                        <span>🗑</span> Clear
                    </button>
                </div>
                
                <div class="toolbar-right">
                    <button id="gridBtn" class="btn btn-gray">
                        <span>👁</span> Grid
                    </button>
                    <button id="saveBtn" class="btn btn-green">
                        <span>💾</span> Save
                    </button>
                </div>
            </div>

            <div class="content-area">
                <div class="sidebar">
                    <div class="sidebar-section">
                        <label class="sidebar-label">Tools</label>
                        <div class="tool-grid">
                            <button id="addTool" class="tool-btn active">
                                <span>➕</span> Add Life Event
                            </button>
                            <button id="moveTool" class="tool-btn">
                                <span>✋</span> Select & Move Points
                            </button>
                        </div>
                    </div>

                    <div id="selectedControls" class="sidebar-section selected-controls hidden">
                        <div class="selected-title">Point <span id="selectedPointNum">1</span> Selected</div>
                        <div>
                            <label class="form-label">Size</label>
                            <div class="size-controls">
                                <button class="size-btn" data-size="6">6</button>
                                <button class="size-btn" data-size="8">8</button>
                                <button class="size-btn" data-size="10">10</button>
                                <button class="size-btn" data-size="12">12</button>
                                <button class="size-btn" data-size="15">15</button>
                            </div>
                        </div>
                        <div class="control-buttons">
                            <button id="editPointBtn" class="btn btn-blue">Edit</button>
                            <button id="deletePointBtn" class="btn btn-red">Delete</button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <label class="sidebar-label">Emotion Color</label>
                        <div class="color-grid">
                            <button class="color-btn active" style="background-color: #3B82F6" data-color="#3B82F6" title="Hope"></button>
                            <button class="color-btn" style="background-color: #10B981" data-color="#10B981" title="Growth"></button>
                            <button class="color-btn" style="background-color: #F59E0B" data-color="#F59E0B" title="Energy"></button>
                            <button class="color-btn" style="background-color: #EF4444" data-color="#EF4444" title="Passion"></button>
                            <button class="color-btn" style="background-color: #8B5CF6" data-color="#8B5CF6" title="Dreams"></button>
                            <button class="color-btn" style="background-color: #06B6D4" data-color="#06B6D4" title="Clarity"></button>
                            <button class="color-btn" style="background-color: #84CC16" data-color="#84CC16" title="Fresh Start"></button>
                            <button class="color-btn" style="background-color: #F97316" data-color="#F97316" title="Courage"></button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="instructions">
                            <div><strong>Add Mode:</strong> Click canvas to add life events</div>
                            <div><strong>Move Mode:</strong> Click to select points, drag to move</div>
                            <div id="selectedInstruction" class="selected-instruction hidden"></div>
                        </div>
                    </div>
                </div>

                <div class="canvas-area">
                    <div class="canvas-header">
                        <h3 class="canvas-title">Your Life Journey Canvas</h3>
                        <p id="canvasDescription" class="canvas-description">
                            Click anywhere to add a life event - you'll choose the connection style for the next segment
                        </p>
                    </div>
                    
                    <div class="canvas-container">
                        <canvas id="lifelineCanvas" width="800" height="500"></canvas>
                    </div>
                    
                    <div class="canvas-footer">
                        Life events: <span id="eventCount">0</span>
                        <div id="journeyMessage" class="hidden">
                            Each point represents a meaningful chapter in your unique journey
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Dialog Modal -->
    <div id="eventModal" class="modal-overlay hidden">
        <div class="modal">
            <h3 id="modalTitle" class="modal-title">Add Life Event</h3>
            
            <div class="form-group">
                <label class="form-label">Event Description</label>
                <input type="text" id="eventInput" class="form-input" placeholder="e.g., Started college, Got married, Career breakthrough...">
            </div>

            <div id="styleSelection" class="form-group">
                <label class="form-label">Connection to Next Event</label>
                <div class="style-grid">
                    <button class="style-btn active" data-style="solid">
                        <div class="style-header">
                            <span class="style-icon">━</span>
                            <span class="style-name">Steady Progress</span>
                        </div>
                        <div class="style-description">Consistent, stable period</div>
                    </button>
                    <button class="style-btn" data-style="dashed">
                        <div class="style-header">
                            <span class="style-icon">┅</span>
                            <span class="style-name">Uncertain Path</span>
                        </div>
                        <div class="style-description">Period of exploration or doubt</div>
                    </button>
                    <button class="style-btn" data-style="dotted">
                        <div class="style-header">
                            <span class="style-icon">⋯</span>
                            <span class="style-name">Small Steps</span>
                        </div>
                        <div class="style-description">Gradual, methodical progress</div>
                    </button>
                    <button class="style-btn" data-style="zigzag">
                        <div class="style-header">
                            <span class="style-icon">⚡</span>
                            <span class="style-name">Challenging Times</span>
                        </div>
                        <div class="style-description">Ups and downs, obstacles</div>
                    </button>
                    <button class="style-btn" data-style="curved">
                        <div class="style-header">
                            <span class="style-icon">〜</span>
                            <span class="style-name">Flowing Growth</span>
                        </div>
                        <div class="style-description">Natural, organic development</div>
                    </button>
                    <button class="style-btn" data-style="rough">
                        <div class="style-header">
                            <span class="style-icon">≈≈</span>
                            <span class="style-name">Turbulent Period</span>
                        </div>
                        <div class="style-description">Chaotic or difficult times</div>
                    </button>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="modalCancel" class="modal-btn modal-btn-cancel">Cancel</button>
                <button id="modalConfirm" class="modal-btn modal-btn-confirm">Add to Life-Line</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let points = [];
        let currentColor = '#3B82F6';
        let showGrid = true;
        let selectedTool = 'add';
        let undoStack = [];
        let selectedPoint = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let pendingPoint = null;
        let selectedLineStyle = 'solid';
        let isEditingExistingPoint = false;
        let editingPointIndex = null;

        // DOM Elements
        const canvas = document.getElementById('lifelineCanvas');
        const ctx = canvas.getContext('2d');
        const eventModal = document.getElementById('eventModal');
        const eventInput = document.getElementById('eventInput');
        const selectedControls = document.getElementById('selectedControls');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            redrawCanvas();
        });

        function setupEventListeners() {
            // Tool buttons
            document.getElementById('addTool').addEventListener('click', () => setTool('add'));
            document.getElementById('moveTool').addEventListener('click', () => setTool('move'));

            // Toolbar buttons
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('clearBtn').addEventListener('click', clearCanvas);
            document.getElementById('gridBtn').addEventListener('click', toggleGrid);
            document.getElementById('saveBtn').addEventListener('click', saveCanvas);

            // Color buttons
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => setColor(btn.dataset.color));
            });

            // Canvas events
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            canvas.addEventListener('dblclick', handleDoubleClick);

            // Size buttons
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => resizeSelectedPoint(parseInt(btn.dataset.size)));
            });

            // Point controls
            document.getElementById('editPointBtn').addEventListener('click', editSelectedPoint);
            document.getElementById('deletePointBtn').addEventListener('click', deleteSelectedPoint);

            // Modal events
            document.getElementById('modalCancel').addEventListener('click', closeModal);
            document.getElementById('modalConfirm').addEventListener('click', confirmEvent);

            // Style selection
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', () => setLineStyle(btn.dataset.style));
            });

            // Keyboard events
            document.addEventListener('keydown', handleKeyDown);
        }

        function setTool(tool) {
            selectedTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
            
            if (tool === 'add') {
                canvas.style.cursor = 'crosshair';
                document.getElementById('canvasDescription').textContent = 
                    "Click anywhere to add a life event - you'll choose the connection style for the next segment";
            } else {
                canvas.style.cursor = selectedPoint !== null ? 'move' : 'pointer';
                updateMoveDescription();
            }
            
            updateSelectedControls();
        }

        function setColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function setLineStyle(style) {
            selectedLineStyle = style;
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-style="${style}"]`).classList.add('active');
        }

        function saveStateToUndo() {
            undoStack.push(JSON.parse(JSON.stringify(points)));
            if (undoStack.length > 10) {
                undoStack.shift();
            }
            updateUndoButton();
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            const undoCount = document.getElementById('undoCount');
            undoBtn.disabled = undoStack.length === 0;
            undoCount.textContent = undoStack.length;
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            if (showGrid) {
                ctx.strokeStyle = '#F3F4F6';
                ctx.lineWidth = 1;
                for (let i = 0; i <= canvas.width; i += 25) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i <= canvas.height; i += 25) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                    ctx.stroke();
                }
            }

            // Draw lines between points
            if (points.length > 1) {
                for (let i = 0; i < points.length - 1; i++) {
                    const current = points[i];
                    const next = points[i + 1];
                    
                    ctx.strokeStyle = current.color;
                    ctx.lineWidth = 4;
                    
                    drawLine(current, next, current.nextLineStyle || 'solid');
                }
            }

            // Draw points
            points.forEach((point, index) => {
                const isSelected = selectedPoint === index;
                
                // Draw selection bounding box if selected
                if (isSelected) {
                    const boxSize = 24;
                    ctx.strokeStyle = '#3B82F6';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([4, 4]);
                    ctx.strokeRect(point.x - boxSize/2, point.y - boxSize/2, boxSize, boxSize);
                    
                    // Draw resize handles
                    const handleSize = 6;
                    const handles = [
                        { x: point.x - boxSize/2, y: point.y - boxSize/2 },
                        { x: point.x + boxSize/2, y: point.y - boxSize/2 },
                        { x: point.x - boxSize/2, y: point.y + boxSize/2 },
                        { x: point.x + boxSize/2, y: point.y + boxSize/2 }
                    ];
                    
                    handles.forEach(handle => {
                        ctx.fillStyle = '#3B82F6';
                        ctx.fillRect(handle.x - handleSize/2, handle.y - handleSize/2, handleSize, handleSize);
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(handle.x - handleSize/2 + 1, handle.y - handleSize/2 + 1, handleSize - 2, handleSize - 2);
                    });
                    
                    ctx.setLineDash([]);
                }

                // Draw point shadow
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.beginPath();
                ctx.arc(point.x + 2, point.y + 2, point.size || 8, 0, 2 * Math.PI);
                ctx.fill();

                // Draw main point
                ctx.fillStyle = point.color;
                ctx.beginPath();
                ctx.arc(point.x, point.y, point.size || 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw white center
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(point.x, point.y, (point.size || 8) * 0.5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw event label
                if (point.label) {
                    ctx.fillStyle = isSelected ? '#3B82F6' : '#374151';
                    ctx.font = isSelected ? 'bold 13px system-ui' : 'bold 12px system-ui';
                    const textWidth = ctx.measureText(point.label).width;
                    
                    let labelX = point.x + 15;
                    let labelY = point.y - 15;
                    
                    if (labelX + textWidth > canvas.width - 10) {
                        labelX = point.x - textWidth - 15;
                    }
                    if (labelY < 20) {
                        labelY = point.y + 25;
                    }
                    
                    ctx.fillText(point.label, labelX, labelY);
                }
                
                // Add sequence numbers
                ctx.fillStyle = '#6B7280';
                ctx.font = 'bold 10px system-ui';
                ctx.textAlign = 'center';
                ctx.fillText((index + 1).toString(), point.x, point.y + 2);
                ctx.textAlign = 'left';
                
                // Special labels for start/end
                if (index === 0) {
                    ctx.fillStyle = '#059669';
                    ctx.font = 'bold 11px system-ui';
                    ctx.fillText('START', point.x - 20, point.y - 30);
                }
                if (index === points.length - 1 && points.length > 1) {
                    ctx.fillStyle = '#DC2626';
                    ctx.font = 'bold 11px system-ui';
                    ctx.fillText('NOW', point.x - 15, point.y - 30);
                }
            });

            updateEventCount();
        }

        function drawLine(start, end, style) {
            ctx.beginPath();
            
            switch (style) {
                case 'solid':
                    ctx.setLineDash([]);
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    break;
                case 'dashed':
                    ctx.setLineDash([15, 10]);
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    break;
                case 'dotted':
                    ctx.setLineDash([4, 8]);
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    break;
                case 'zigzag':
                    ctx.setLineDash([]);
                    drawZigzag(start, end);
                    break;
                case 'curved':
                    ctx.setLineDash([]);
                    drawCurvedLine(start, end);
                    break;
                case 'rough':
                    ctx.setLineDash([]);
                    drawRoughLine(start, end);
                    break;
            }
            ctx.stroke();
        }

        function drawZigzag(start, end) {
            const segments = 10;
            const dx = (end.x - start.x) / segments;
            const dy = (end.y - start.y) / segments;
            
            ctx.moveTo(start.x, start.y);
            for (let i = 1; i <= segments; i++) {
                const x = start.x + dx * i;
                const baseY = start.y + dy * i;
                const zigzagY = baseY + (i % 2 === 0 ? -12 : 12);
                ctx.lineTo(x, zigzagY);
            }
        }

        function drawCurvedLine(start, end) {
            const midX = (start.x + end.x) / 2;
            const midY = (start.y + end.y) / 2 - 40;
            ctx.moveTo(start.x, start.y);
            ctx.quadraticCurveTo(midX, midY, end.x, end.y);
        }

        function drawRoughLine(start, end) {
            const segments = 25;
            const dx = (end.x - start.x) / segments;
            const dy = (end.y - start.y) / segments;
            
            ctx.moveTo(start.x, start.y);
            for (let i = 1; i <= segments; i++) {
                const x = start.x + dx * i + (Math.random() - 0.5) * 10;
                const y = start.y + dy * i + (Math.random() - 0.5) * 10;
                ctx.lineTo(x, y);
            }
        }

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (selectedTool === 'add') {
                pendingPoint = { x, y };
                isEditingExistingPoint = false;
                openModal(false);
            } else if (selectedTool === 'move') {
                let pointClicked = false;
                for (let i = 0; i < points.length; i++) {
                    const point = points[i];
                    const distance = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2);
                    if (distance <= (point.size || 8) + 5) {
                        selectedPoint = selectedPoint === i ? null : i;
                        pointClicked = true;
                        break;
                    }
                }
                
                if (!pointClicked) {
                    selectedPoint = null;
                }
                
                updateSelectedControls();
                updateMoveDescription();
                redrawCanvas();
            }
        }

        function handleMouseDown(e) {
            if (selectedTool !== 'move' || selectedPoint === null) return;
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const point = points[selectedPoint];
            const boxSize = 24;
            const inBoundingBox = mouseX >= point.x - boxSize/2 && 
                                mouseX <= point.x + boxSize/2 && 
                                mouseY >= point.y - boxSize/2 && 
                                mouseY <= point.y + boxSize/2;
            
            if (inBoundingBox) {
                isDragging = true;
                dragOffset = {
                    x: mouseX - point.x,
                    y: mouseY - point.y
                };
            }
        }

        function handleMouseMove(e) {
            if (selectedTool !== 'move' || !isDragging || selectedPoint === null) return;
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const newX = Math.max(20, Math.min(canvas.width - 20, mouseX - dragOffset.x));
            const newY = Math.max(20, Math.min(canvas.height - 20, mouseY - dragOffset.y));

            points[selectedPoint].x = newX;
            points[selectedPoint].y = newY;
            redrawCanvas();
        }

        function handleMouseUp() {
            if (isDragging && selectedPoint !== null) {
                saveStateToUndo();
            }
            isDragging = false;
            dragOffset = { x: 0, y: 0 };
        }

        function handleDoubleClick(e) {
            if (selectedTool !== 'move' || selectedPoint === null) return;
            editSelectedPoint();
        }

        function handleKeyDown(e) {
            if (e.key === 'Delete' && selectedPoint !== null) {
                deleteSelectedPoint();
            }
            if (e.key === 'Escape') {
                closeModal();
                selectedPoint = null;
                updateSelectedControls();
                redrawCanvas();
            }
        }

        function openModal(editing = false) {
            eventModal.classList.remove('hidden');
            document.getElementById('modalTitle').textContent = editing ? 'Edit Life Event' : 'Add Life Event';
            document.getElementById('modalConfirm').textContent = editing ? 'Update Event' : 'Add to Life-Line';
            document.getElementById('styleSelection').classList.toggle('hidden', editing);
            eventInput.focus();
        }

        function closeModal() {
            eventModal.classList.add('hidden');
            eventInput.value = '';
            selectedLineStyle = 'solid';
            pendingPoint = null;
            isEditingExistingPoint = false;
            editingPointIndex = null;
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-style="solid"]').classList.add('active');
        }

        function confirmEvent() {
            if (pendingPoint) {
                saveStateToUndo();
                
                if (isEditingExistingPoint) {
                    points[editingPointIndex].label = eventInput.value.trim();
                    points[editingPointIndex].nextLineStyle = selectedLineStyle;
                } else {
                    const newPoint = {
                        x: pendingPoint.x,
                        y: pendingPoint.y,
                        color: currentColor,
                        size: 8,
                        label: eventInput.value.trim() || `Event ${points.length + 1}`,
                        nextLineStyle: selectedLineStyle,
                        id: Date.now()
                    };
                    points.push(newPoint);
                }
                
                redrawCanvas();
            }
            closeModal();
        }

        function updateSelectedControls() {
            const controls = document.getElementById('selectedControls');
            const instruction = document.getElementById('selectedInstruction');
            
            if (selectedPoint !== null && selectedTool === 'move') {
                controls.classList.remove('hidden');
                document.getElementById('selectedPointNum').textContent = selectedPoint + 1;
                
                // Update size buttons
                const currentSize = points[selectedPoint].size || 8;
                document.querySelectorAll('.size-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.size) === currentSize);
                });
                
                instruction.classList.remove('hidden');
                instruction.textContent = `Point ${selectedPoint + 1} selected - use controls above to edit`;
            } else {
                controls.classList.add('hidden');
                instruction.classList.add('hidden');
            }
        }

        function updateMoveDescription() {
            if (selectedTool === 'move') {
                const desc = document.getElementById('canvasDescription');
                if (selectedPoint !== null) {
                    desc.textContent = 'Selected point can be dragged to move. Use sidebar controls to resize, edit, or delete.';
                } else {
                    desc.textContent = 'Click any point to select it, then drag to move or use sidebar controls';
                }
            }
        }

        function updateEventCount() {
            document.getElementById('eventCount').textContent = points.length;
            const message = document.getElementById('journeyMessage');
            if (points.length > 0) {
                message.classList.remove('hidden');
            } else {
                message.classList.add('hidden');
            }
        }

        function resizeSelectedPoint(newSize) {
            if (selectedPoint !== null) {
                saveStateToUndo();
                points[selectedPoint].size = newSize;
                updateSelectedControls();
                redrawCanvas();
            }
        }

        function editSelectedPoint() {
            if (selectedPoint !== null) {
                const point = points[selectedPoint];
                pendingPoint = { x: point.x, y: point.y };
                eventInput.value = point.label || '';
                selectedLineStyle = point.nextLineStyle || 'solid';
                isEditingExistingPoint = true;
                editingPointIndex = selectedPoint;
                
                // Update style selection
                document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-style="${selectedLineStyle}"]`).classList.add('active');
                
                openModal(true);
            }
        }

        function deleteSelectedPoint() {
            if (selectedPoint !== null) {
                saveStateToUndo();
                points.splice(selectedPoint, 1);
                selectedPoint = null;
                updateSelectedControls();
                redrawCanvas();
            }
        }

        function undo() {
            if (undoStack.length > 0) {
                points = undoStack.pop();
                selectedPoint = null;
                updateUndoButton();
                updateSelectedControls();
                redrawCanvas();
            }
        }

        function clearCanvas() {
            if (points.length > 0 && confirm('Are you sure you want to clear all points?')) {
                saveStateToUndo();
                points = [];
                selectedPoint = null;
                updateSelectedControls();
                redrawCanvas();
            }
        }

        function toggleGrid() {
            showGrid = !showGrid;
            document.getElementById('gridBtn').innerHTML = showGrid ? 
                '<span>👁</span> Grid' : '<span>🚫</span> Grid';
            redrawCanvas();
        }

        function saveCanvas() {
            const link = document.createElement('a');
            link.download = 'my-lifeline.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Event listeners for modal interactions
        eventInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmEvent();
            }
        });

        // Close modal when clicking outside
        eventModal.addEventListener('click', function(e) {
            if (e.target === eventModal) {
                closeModal();
            }
        });
    </script>
</body>
</html>
