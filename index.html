<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life-Line Creator - Intention by Design</title>
    <style>
        /* BASE STYLES (Kept as provided) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #f3e8ff 50%, #fce7f3 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(to right, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #4b5563;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .description {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .main-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* TOOLBAR STYLES */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-blue { background: #dbeafe; color: #1d4ed8; }
        .btn-blue:hover:not(:disabled) { background: #bfdbfe; }
        .btn-red { background: #fee2e2; color: #dc2626; }
        .btn-red:hover:not(:disabled) { background: #fecaca; }
        .btn-gray { background: #f3f4f6; color: #374151; }
        .btn-gray:hover:not(:disabled) { background: #e5e7eb; }
        .btn-green { background: #dcfce7; color: #16a34a; }
        .btn-green:hover:not(:disabled) { background: #bbf7d0; }

        /* CONTENT & SIDEBAR STYLES */
        .content-area {
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: #f9fafb;
            padding: 1rem;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            max-height: 600px;
        }

        .sidebar-section {
            margin-bottom: 1rem;
        }

        .sidebar-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .tool-btn {
            /* Tool button styles... */
        }

        .tool-btn.active.add-tool {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .tool-btn.active.move-tool {
            background: #10b981; /* Use a different color for 'move' tool */
            color: white;
            border-color: #10b981;
        }

        .color-grid {
            /* Color grid styles... */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .color-btn {
            /* Color button styles... */
            width: 3rem;
            height: 3rem;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-btn.active {
            transform: scale(1.1);
            border-color: #6b7280;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        /* SELECTED CONTROLS STYLES (Point editing sidebar) */
        .selected-controls {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 0.75rem;
        }
        
        /* CANVAS STYLES */
        .canvas-area {
            flex: 1;
            padding: 1rem;
        }

        .canvas-container {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            overflow: hidden;
        }

        #lifelineCanvas {
            display: block;
            width: 100%;
            height: auto;
            background: white;
            /* Added touch action none for better dragging on touch screens */
            touch-action: none; 
        }

        .cursor-crosshair { cursor: crosshair; }
        .cursor-move { cursor: move; }
        .cursor-default { cursor: default; }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Added specific style to show/hide section of modal */
        .modal-element-hidden {
            display: none !important;
        }

        /* MEDIA QUERIES (Kept as provided) */
        @media (max-width: 768px) {
            .content-area {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .toolbar-left, .toolbar-right {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Life-Line Creator</h1>
            <p class="subtitle">From "Intention by Design" - Volume 1: Designing Your Life-Line</p>
            <p class="description">Create an interactive visualization of your unique life journey</p>
        </div>

        <div class="main-container">
            <div class="toolbar">
                <div class="toolbar-left">
                    <button id="undoBtn" class="btn btn-blue" disabled>
                        <span>‚Ü∂</span> Undo (<span id="undoCount">0</span>)
                    </button>
                    <button id="clearBtn" class="btn btn-red">
                        <span>üóë</span> Clear
                    </button>
                </div>
                
                <div class="toolbar-right">
                    <button id="gridBtn" class="btn btn-gray">
                        <span>üëÅ</span> Grid
                    </button>
                    <button id="saveBtn" class="btn btn-green">
                        <span>üíæ</span> Save
                    </button>
                </div>
            </div>

            <div class="content-area">
                <div class="sidebar">
                    <div class="sidebar-section">
                        <label class="sidebar-label">Tools</label>
                        <div class="tool-grid">
                            <button id="addTool" class="tool-btn active add-tool">
                                <span>‚ûï</span> Add Life Event
                            </button>
                            <button id="moveTool" class="tool-btn move-tool">
                                <span>‚úã</span> Select & Move Points
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <label class="sidebar-label">All Points</label>
                        <div id="pointList" class="point-list">
                            <div class="point-item" style="text-align: center; color: #9ca3af; padding: 1rem;">
                                No points yet. Click "Add Life Event" and click on the canvas.
                            </div>
                        </div>
                    </div>

                    <div id="selectedControls" class="sidebar-section selected-controls hidden">
                        <div class="selected-title">Point <span id="selectedPointNum">1</span> Selected</div>
                        
                        <div>
                            <label class="form-label">Position (X, Y)</label>
                            <div class="coordinate-controls">
                                <input type="number" id="xCoord" class="coordinate-input" placeholder="X" min="20" max="780">
                                <input type="number" id="yCoord" class="coordinate-input" placeholder="Y" min="20" max="480">
                            </div>
                            <button id="applyCoords" class="btn btn-blue" style="width: 100%; font-size: 0.75rem; padding: 0.25rem;">
                                Apply Position
                            </button>
                        </div>
                        
                        <div>
                            <label class="form-label">Point Size</label>
                            <div class="size-controls">
                                <button class="size-btn" data-size="6">6</button>
                                <button class="size-btn" data-size="8">8</button>
                                <button class="size-btn" data-size="10">10</button>
                                <button class="size-btn" data-size="12">12</button>
                                <button class="size-btn" data-size="15">15</button>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Line Thickness</label>
                            <div class="thickness-controls">
                                <button class="thickness-btn" data-thickness="2">2</button>
                                <button class="thickness-btn" data-thickness="3">3</button>
                                <button class="thickness-btn" data-thickness="4">4</button>
                                <button class="thickness-btn" data-thickness="6">6</button>
                                <button class="thickness-btn" data-thickness="8">8</button>
                            </div>
                        </div>
                        <div class="control-buttons">
                            <button id="editPointBtn" class="btn btn-blue">Edit Details</button>
                            <button id="deletePointBtn" class="btn btn-red">Delete Point</button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <label class="sidebar-label">Event Numbers</label>
                        <div class="number-controls">
                            <button id="numbersOn" class="number-btn active">Show</button>
                            <button id="numbersOff" class="number-btn">Hide</button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <label class="sidebar-label">New Point Emotion Color</label>
                        <div class="color-grid">
                            <button class="color-btn active" style="background-color: #3B82F6" data-color="#3B82F6" title="Hope"></button>
                            <button class="color-btn" style="background-color: #10B981" data-color="#10B981" title="Growth"></button>
                            <button class="color-btn" style="background-color: #F59E0B" data-color="#F59E0B" title="Energy"></button>
                            <button class="color-btn" style="background-color: #EF4444" data-color="#EF4444" title="Passion"></button>
                            <button class="color-btn" style="background-color: #8B5CF6" data-color="#8B5CF6" title="Dreams"></button>
                            <button class="color-btn" style="background-color: #06B6D4" data-color="#06B6D4" title="Clarity"></button>
                            <button class="color-btn" style="background-color: #84CC16" data-color="#84CC16" title="Fresh Start"></button>
                            <button class="color-btn" style="background-color: #F97316" data-color="#F97316" title="Courage"></button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="instructions">
                            <div><strong>Add Mode:</strong> Click canvas to add life events</div>
                            <div><strong>Move Mode:</strong> Click to select points, drag to move</div>
                            <div id="selectedInstruction" class="selected-instruction hidden"></div>
                        </div>
                    </div>
                </div>

                <div class="canvas-area">
                    <div class="canvas-header">
                        <h3 class="canvas-title">Your Life Journey Canvas</h3>
                        <p id="canvasDescription" class="canvas-description">
                            Click anywhere to add a life event - you'll choose the connection style for the next segment
                        </p>
                    </div>
                    
                    <div class="canvas-container">
                        <canvas id="lifelineCanvas" width="800" height="500"></canvas>
                    </div>
                    
                    <div class="canvas-footer">
                        Life events: <span id="eventCount">0</span>
                        <div id="journeyMessage" class="hidden">
                            Each point represents a meaningful chapter in your unique journey
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay hidden">
        <div class="modal">
            <h3 id="modalTitle" class="modal-title">Add Life Event</h3>
            
            <div class="form-group">
                <label class="form-label">Event Description</label>
                <input type="text" id="eventInput" class="form-input" placeholder="e.g., Started college, Got married, Career breakthrough...">
            </div>

            <div id="styleSelection" class="form-group">
                <label class="form-label">Connection to Next Event</label>
                <div class="style-grid">
                    <button class="style-btn active" data-style="solid">
                        <div class="style-header">
                            <span class="style-icon">‚îÅ</span>
                            <span class="style-name">Steady Progress</span>
                        </div>
                        <div class="style-description">Consistent, stable period</div>
                    </button>
                    <button class="style-btn" data-style="dashed">
                        <div class="style-header">
                            <span class="style-icon">‚îÖ</span>
                            <span class="style-name">Uncertain Path</span>
                        </div>
                        <div class="style-description">Period of exploration or doubt</div>
                    </button>
                    <button class="style-btn" data-style="dotted">
                        <div class="style-header">
                            <span class="style-icon">‚ãØ</span>
                            <span class="style-name">Small Steps</span>
                        </div>
                        <div class="style-description">Gradual, methodical progress</div>
                    </button>
                    <button class="style-btn" data-style="zigzag">
                        <div class="style-header">
                            <span class="style-icon">‚ö°</span>
                            <span class="style-name">Challenging Times</span>
                        </div>
                        <div class="style-description">Ups and downs, obstacles</div>
                    </button>
                    <button class="style-btn" data-style="curved">
                        <div class="style-header">
                            <span class="style-icon">„Äú</span>
                            <span class="style-name">Flowing Growth</span>
                        </div>
                        <div class="style-description">Natural, organic development</div>
                    </button>
                    <button class="style-btn" data-style="knot">
                        <div class="style-header">
                            <span class="style-icon">ü™¢</span>
                            <span class="style-name">Stuck/Trapped</span>
                        </div>
                        <div class="style-description">Being stuck in a difficult situation</div>
                    </button>
                    <button class="style-btn" data-style="rough">
                        <div class="style-header">
                            <span class="style-icon">‚âà‚âà</span>
                            <span class="style-name">Turbulent Period</span>
                        </div>
                        <div class="style-description">Chaotic or difficult times</div>
                    </button>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="modalCancel" class="modal-btn modal-btn-cancel">Cancel</button>
                <button id="modalConfirm" class="modal-btn modal-btn-confirm">Add to Life-Line</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let points = [];
        let currentColor = '#3B82F6';
        let showGrid = true;
        let selectedTool = 'add';
        let undoStack = [];
        let selectedPoint = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let pendingPoint = null;
        let selectedLineStyle = 'solid';
        let isEditingExistingPoint = false;
        let editingPointIndex = null;
        let showNumbers = true;
        let gridSize = 10; 

        // DOM Elements
        const canvas = document.getElementById('lifelineCanvas');
        const ctx = canvas.getContext('2d');
        const eventModal = document.getElementById('eventModal');
        const eventInput = document.getElementById('eventInput');
        const selectedControls = document.getElementById('selectedControls');

        // --- Core Functions (Initial Setup) ---
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            redrawCanvas();
        });

        function setupEventListeners() {
            // Tool buttons
            document.getElementById('addTool').addEventListener('click', () => setTool('add'));
            document.getElementById('moveTool').addEventListener('click', () => setTool('move'));

            // Toolbar buttons
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('clearBtn').addEventListener('click', clearCanvas);
            document.getElementById('gridBtn').addEventListener('click', toggleGrid);
            document.getElementById('saveBtn').addEventListener('click', saveCanvas);

            // Color buttons
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => setColor(btn.dataset.color));
            });

            // Canvas events
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            canvas.addEventListener('dblclick', handleDoubleClick);

            // Size and Thickness buttons
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => resizeSelectedPoint(parseInt(btn.dataset.size)));
            });
            document.querySelectorAll('.thickness-btn').forEach(btn => {
                btn.addEventListener('click', () => setThicknessForSelectedPoint(parseInt(btn.dataset.thickness)));
            });

            // Point controls
            document.getElementById('editPointBtn').addEventListener('click', editSelectedPoint);
            document.getElementById('deletePointBtn').addEventListener('click', deleteSelectedPoint);

            // Coordinate controls
            document.getElementById('applyCoords').addEventListener('click', applyCoordinates);
            document.getElementById('xCoord').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') applyCoordinates();
            });
            document.getElementById('yCoord').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') applyCoordinates();
            });

            // Event Number controls (FIXED: Added listeners)
            document.getElementById('numbersOn').addEventListener('click', () => toggleNumbers(true));
            document.getElementById('numbersOff').addEventListener('click', () => toggleNumbers(false));


            // Modal events
            document.getElementById('modalCancel').addEventListener('click', closeModal);
            document.getElementById('modalConfirm').addEventListener('click', confirmEvent);

            // Style selection
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', () => setLineStyle(btn.dataset.style));
            });

            // Keyboard events
            document.addEventListener('keydown', handleKeyDown);
            eventInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmEvent();
                }
            });
            eventModal.addEventListener('click', function(e) {
                if (e.target === eventModal) {
                    closeModal();
                }
            });
        }

        // --- Utility/State Management Functions ---

        function setTool(tool) {
            selectedTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('add-tool');
                btn.classList.remove('move-tool');
            });
            const toolBtn = document.getElementById(tool + 'Tool');
            toolBtn.classList.add('active');
            toolBtn.classList.add(tool + '-tool');
            
            if (tool === 'add') {
                canvas.className = 'cursor-crosshair';
                document.getElementById('canvasDescription').textContent = 
                    "Click anywhere to add a life event - you'll choose the connection style for the next segment";
            } else {
                canvas.className = selectedPoint !== null ? 'cursor-move' : 'cursor-pointer';
                updateMoveDescription();
            }
            
            updateSelectedControls();
        }

        function setColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.color-grid [data-color="${color}"]`).classList.add('active');
        }

        function setLineStyle(style) {
            selectedLineStyle = style;
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.style-grid [data-style="${style}"]`).classList.add('active');
        }

        function saveStateToUndo() {
            // Only save if the state is actually different
            const newPoints = JSON.stringify(points);
            const lastState = undoStack.length > 0 ? JSON.stringify(undoStack[undoStack.length - 1]) : null;

            if (newPoints !== lastState) {
                undoStack.push(JSON.parse(newPoints));
                if (undoStack.length > 10) {
                    undoStack.shift();
                }
                updateUndoButton();
            }
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            const undoCount = document.getElementById('undoCount');
            undoBtn.disabled = undoStack.length === 0;
            undoCount.textContent = undoStack.length;
        }

        function updateSelectedControls() {
            const controls = document.getElementById('selectedControls');
            const instruction = document.getElementById('selectedInstruction');
            
            if (selectedPoint !== null && selectedTool === 'move') {
                controls.classList.remove('hidden');
                document.getElementById('selectedPointNum').textContent = selectedPoint + 1;
                
                const point = points[selectedPoint];
                document.getElementById('xCoord').value = Math.round(point.x);
                document.getElementById('yCoord').value = Math.round(point.y);
                
                // Update size buttons
                const currentSize = point.size || 8;
                document.querySelectorAll('.size-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.size) === currentSize);
                });
                
                // Update thickness buttons (line *from* this point)
                const currentThickness = point.thickness || 4;
                document.querySelectorAll('.thickness-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.thickness) === currentThickness);
                });
                
                if (instruction) {
                    instruction.classList.remove('hidden');
                    instruction.textContent = `Point ${selectedPoint + 1} selected - use controls above to edit`;
                }
            } else {
                controls.classList.add('hidden');
                if (instruction) {
                    instruction.classList.add('hidden');
                }
            }
        }
        
        function selectPointByIndex(index) {
            selectedPoint = index;
            updateSelectedControls();
            updateMoveDescription();
            updatePointList();
            redrawCanvas();
        }

        // --- Canvas Drawing Functions ---
        
        function drawLine(start, end, style) {
            ctx.beginPath();
            
            switch (style) {
                case 'solid':
                    ctx.setLineDash([]);
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    break;
                case 'dashed':
                    ctx.setLineDash([15, 10]);
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    break;
                case 'dotted':
                    ctx.setLineDash([4, 8]);
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    break;
                case 'zigzag':
                    ctx.setLineDash([]);
                    drawZigzag(start, end);
                    break;
                case 'curved':
                    ctx.setLineDash([]);
                    drawCurvedLine(start, end);
                    break;
                case 'knot':
                    ctx.setLineDash([]);
                    drawKnotLine(start, end);
                    break;
                case 'rough':
                    ctx.setLineDash([]);
                    drawRoughLine(start, end);
                    break;
            }
            ctx.stroke();
            ctx.setLineDash([]); // IMPORTANT: Reset after drawing
        }

        function drawZigzag(start, end) {
            const segments = 10;
            const dx = (end.x - start.x) / segments;
            const dy = (end.y - start.y) / segments;
            const amplitude = 12; // Adjusted for better visibility
            
            ctx.moveTo(start.x, start.y);
            for (let i = 1; i <= segments; i++) {
                const x = start.x + dx * i;
                const baseY = start.y + dy * i;
                // Calculate perpendicular offset for zigzag
                const angle = Math.atan2(end.y - start.y, end.x - start.x);
                const offset = (i % 2 === 0 ? 1 : -1) * amplitude;
                const zigzagX = x + offset * Math.sin(angle);
                const zigzagY = baseY - offset * Math.cos(angle);
                ctx.lineTo(zigzagX, zigzagY);
            }
        }

        function drawCurvedLine(start, end) {
            // Control point set 40px perpendicular to the center of the line
            const midX = (start.x + end.x) / 2;
            const midY = (start.y + end.y) / 2;
            const angle = Math.atan2(end.y - start.y, end.x - start.x);
            const controlPointOffset = 40;
            const controlX = midX + controlPointOffset * Math.sin(angle);
            const controlY = midY - controlPointOffset * Math.cos(angle);

            ctx.moveTo(start.x, start.y);
            ctx.quadraticCurveTo(controlX, controlY, end.x, end.y);
        }

        function drawKnotLine(start, end) {
             // FIX: Simplified knot drawing to be effective but easier to draw
             const segments = 6;
             const dx = (end.x - start.x) / segments;
             const dy = (end.y - start.y) / segments;
             const knotRadius = 10;
             
             ctx.moveTo(start.x, start.y);
             for (let i = 1; i <= segments; i++) {
                 const baseX = start.x + dx * i;
                 const baseY = start.y + dy * i;
                 
                 if (i === 3) {
                     // Draw a small knot/loop in the middle segment
                     ctx.arc(baseX, baseY, knotRadius, 0, 2 * Math.PI, false);
                     ctx.moveTo(baseX + knotRadius, baseY);
                 } else {
                     ctx.lineTo(baseX, baseY);
                 }
             }
             // Ensure line ends at the final point
             ctx.lineTo(end.x, end.y);
        }

        function drawRoughLine(start, end) {
            const segments = 25;
            const dx = (end.x - start.x) / segments;
            const dy = (end.y - start.y) / segments;
            
            ctx.moveTo(start.x, start.y);
            for (let i = 1; i <= segments; i++) {
                const x = start.x + dx * i + (Math.random() - 0.5) * 10;
                const y = start.y + dy * i + (Math.random() - 0.5) * 10;
                ctx.lineTo(x, y);
            }
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            if (showGrid) {
                ctx.strokeStyle = '#F3F4F6';
                ctx.lineWidth = 0.5;
                for (let i = 0; i <= canvas.width; i += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i <= canvas.height; i += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                    ctx.stroke();
                }
                
                // Major grid lines
                ctx.strokeStyle = '#E5E7EB';
                ctx.lineWidth = 1;
                for (let i = 0; i <= canvas.width; i += 50) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i <= canvas.height; i += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                    ctx.stroke();
                }
            }

            // Draw lines between points
            if (points.length > 1) {
                for (let i = 0; i < points.length - 1; i++) {
                    const current = points[i];
                    const next = points[i + 1];
                    
                    ctx.strokeStyle = current.color;
                    ctx.lineWidth = current.thickness || 4;
                    
                    drawLine(current, next, current.nextLineStyle || 'solid');
                }
            }

            // Draw points
            points.forEach((point, index) => {
                const isSelected = selectedPoint === index;
                const size = point.size || 8;
                
                // Draw selection bounding box
                if (isSelected) {
                    const boxSize = 24;
                    ctx.strokeStyle = '#3B82F6';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([4, 4]);
                    ctx.strokeRect(point.x - boxSize/2, point.y - boxSize/2, boxSize, boxSize);
                    ctx.setLineDash([]); 
                }

                // Draw point shadow
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.beginPath();
                ctx.arc(point.x + 2, point.y + 2, size, 0, 2 * Math.PI);
                ctx.fill();

                // Draw main point
                ctx.fillStyle = point.color;
                ctx.beginPath();
                ctx.arc(point.x, point.y, size, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw white center
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(point.x, point.y, size * 0.5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw event label and numbers... (rest of the drawing logic)
                if (point.label) {
                    ctx.fillStyle = isSelected ? '#3B82F6' : '#374151';
                    ctx.font = isSelected ? 'bold 13px system-ui' : 'bold 12px system-ui';
                    const textWidth = ctx.measureText(point.label).width;
                    
                    let labelX = point.x + 15;
                    let labelY = point.y - 15;
                    
                    if (labelX + textWidth > canvas.width - 10) {
                        labelX = point.x - textWidth - 15;
                    }
                    if (labelY < 20) {
                        labelY = point.y + 25;
                    }
                    
                    ctx.fillText(point.label, labelX, labelY);
                }
                
                // Add sequence numbers
                if (showNumbers) {
                    ctx.fillStyle = '#6B7280';
                    ctx.font = 'bold 10px system-ui';
                    ctx.textAlign = 'center';
                    ctx.fillText((index + 1).toString(), point.x, point.y + 2);
                    ctx.textAlign = 'left';
                }
                
                // Special labels for start/end
                if (index === 0) {
                    ctx.fillStyle = '#059669';
                    ctx.font = 'bold 11px system-ui';
                    ctx.fillText('START', point.x - 20, point.y - 30);
                }
                if (index === points.length - 1 && points.length > 1) {
                    ctx.fillStyle = '#DC2626';
                    ctx.font = 'bold 11px system-ui';
                    ctx.fillText('NOW', point.x - 15, point.y - 30);
                }
            });

            updateEventCount();
            updatePointList();
        }

        // --- Event Handlers for Canvas Interaction ---
        
        function getPointIndexAtCoords(x, y) {
            for (let i = 0; i < points.length; i++) {
                const point = points[i];
                const distance = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2);
                // Check distance including a buffer around the point's size
                if (distance <= (point.size || 8) + 5) {
                    return i;
                }
            }
            return null;
        }

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (selectedTool === 'add') {
                pendingPoint = { x, y };
                isEditingExistingPoint = false;
                // Default to first line style
                selectedLineStyle = document.querySelector('.style-grid .style-btn').dataset.style; 
                document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('[data-style="solid"]').classList.add('active');
                openModal(false);
            } else if (selectedTool === 'move') {
                const clickedIndex = getPointIndexAtCoords(x, y);
                // Only toggle selection if not starting a drag (handled by mousedown)
                if (clickedIndex !== null && !isDragging) { 
                    selectPointByIndex(clickedIndex);
                } else if (clickedIndex === null) {
                    selectPointByIndex(null);
                }
            }
        }

        function handleMouseDown(e) {
            if (selectedTool !== 'move') return;
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const clickedIndex = getPointIndexAtCoords(mouseX, mouseY);
            
            if (clickedIndex !== null) {
                // Select the point if it wasn't already selected
                if (selectedPoint !== clickedIndex) {
                    selectPointByIndex(clickedIndex);
                }
                
                // Start drag operation
                isDragging = true;
                dragOffset = {
                    x: mouseX - points[clickedIndex].x,
                    y: mouseY - points[clickedIndex].y
                };
                canvas.className = 'cursor-move';
            }
        }

        function handleMouseMove(e) {
            if (!isDragging || selectedPoint === null) return;
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // Clamp coordinates within the canvas bounds with a 20px padding
            const newX = Math.max(20, Math.min(canvas.width - 20, mouseX - dragOffset.x));
            const newY = Math.max(20, Math.min(canvas.height - 20, mouseY - dragOffset.y));

            // Update state and redraw
            points[selectedPoint].x = newX;
            points[selectedPoint].y = newY;
            
            // Update the coordinate inputs in the sidebar in real-time
            document.getElementById('xCoord').value = Math.round(newX);
            document.getElementById('yCoord').value = Math.round(newY);

            redrawCanvas();
        }

        function handleMouseUp() {
            if (isDragging && selectedPoint !== null) {
                saveStateToUndo(); // Save after drag complete
            }
            isDragging = false;
            dragOffset = { x: 0, y: 0 };
            if (selectedTool === 'move') {
                canvas.className = selectedPoint !== null ? 'cursor-move' : 'cursor-pointer';
            } else {
                canvas.className = 'cursor-crosshair';
            }
        }

        // --- Editing and Deleting Functions ---

        function resizeSelectedPoint(newSize) {
            if (selectedPoint !== null) {
                saveStateToUndo();
                points[selectedPoint].size = newSize;
                updateSelectedControls();
                redrawCanvas();
            }
        }

        function setThicknessForSelectedPoint(newThickness) {
            if (selectedPoint !== null) {
                saveStateToUndo();
                // We store thickness on the current point, for the line segment that follows it
                points[selectedPoint].thickness = newThickness; 
                updateSelectedControls();
                redrawCanvas();
            }
        }

        function editSelectedPoint() {
            if (selectedPoint !== null) {
                const point = points[selectedPoint];
                
                // Determine if this is the last point to hide line style selection
                const isLast = selectedPoint === points.length - 1;

                pendingPoint = { x: point.x, y: point.y };
                eventInput.value = point.label || '';
                selectedLineStyle = point.nextLineStyle || 'solid';
                isEditingExistingPoint = true;
                editingPointIndex = selectedPoint;
                
                // Update style selection in modal
                document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
                const styleBtn = document.querySelector(`.style-grid [data-style="${selectedLineStyle}"]`);
                if (styleBtn) {
                    styleBtn.classList.add('active');
                }
                
                openModal(true, isLast);
            }
        }

        function deleteSelectedPoint() {
            if (selectedPoint !== null && confirm('Are you sure you want to delete this event?')) {
                saveStateToUndo();
                points.splice(selectedPoint, 1);
                selectPointByIndex(null);
            }
        }

        function applyCoordinates() {
            if (selectedPoint === null) return;
            
            const xInput = document.getElementById('xCoord');
            const yInput = document.getElementById('yCoord');
            
            const newX = parseInt(xInput.value);
            const newY = parseInt(yInput.value);
            
            if (isNaN(newX) || isNaN(newY)) {
                alert('Please enter valid numbers for X and Y coordinates');
                return;
            }
            
            // Re-clamp input values just in case
            const clampedX = Math.max(20, Math.min(canvas.width - 20, newX));
            const clampedY = Math.max(20, Math.min(canvas.height - 20, newY));
            
            if (clampedX !== newX || clampedY !== newY) {
                 alert('Coordinates were adjusted to fit within canvas bounds (X: 20-780, Y: 20-480)');
            }

            saveStateToUndo();
            points[selectedPoint].x = clampedX;
            points[selectedPoint].y = clampedY;
            
            updatePointList();
            redrawCanvas();
        }

        // --- Modal Functions ---

        function openModal(editing = false, isLast = false) {
            eventModal.classList.remove('hidden');
            document.getElementById('modalTitle').textContent = editing ? 'Edit Life Event' : 'Add Life Event';
            document.getElementById('modalConfirm').textContent = editing ? 'Update Event' : 'Add to Life-Line';
            
            // Hide line style selection if editing the last point
            document.getElementById('styleSelection').classList.toggle('modal-element-hidden', isLast); 
            
            eventInput.focus();
        }

        function closeModal() {
            eventModal.classList.add('hidden');
            eventInput.value = '';
            selectedLineStyle = 'solid';
            pendingPoint = null;
            isEditingExistingPoint = false;
            editingPointIndex = null;
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-style="solid"]').classList.add('active');
        }

        function confirmEvent() {
            if (pendingPoint) {
                saveStateToUndo();
                
                if (isEditingExistingPoint) {
                    // Editing existing point: update label and nextLineStyle
                    points[editingPointIndex].label = eventInput.value.trim();
                    // Only update nextLineStyle if it was visible (i.e., not the last point)
                    if (editingPointIndex < points.length - 1) {
                         points[editingPointIndex].nextLineStyle = selectedLineStyle;
                    }
                } else {
                    // Adding new point
                    const newPoint = {
                        x: pendingPoint.x,
                        y: pendingPoint.y,
                        color: currentColor,
                        size: 8, // Default size
                        thickness: 4, // Default thickness
                        label: eventInput.value.trim() || `Event ${points.length + 1}`,
                        nextLineStyle: selectedLineStyle,
                        id: Date.now()
                    };
                    points.push(newPoint);
                    selectPointByIndex(points.length - 1);
                }
                
                redrawCanvas();
            }
            closeModal();
        }

        // --- Global Actions ---
        
        function undo() {
            if (undoStack.length > 0) {
                // Pop the old state and set it as the current state
                points = undoStack.pop(); 
                selectPointByIndex(null);
                updateUndoButton();
                redrawCanvas();
            }
        }

        function clearCanvas() {
            if (points.length > 0 && confirm('Are you sure you want to clear all points?')) {
                saveStateToUndo();
                points = [];
                selectPointByIndex(null);
                redrawCanvas();
            }
        }

        function toggleGrid() {
            showGrid = !showGrid;
            document.getElementById('gridBtn').innerHTML = showGrid ? 
                '<span>üëÅ</span> Grid' : '<span>üö´</span> Grid';
            redrawCanvas();
        }

        function toggleNumbers(show) {
            showNumbers = show;
            document.getElementById('numbersOn').classList.toggle('active', show);
            document.getElementById('numbersOff').classList.toggle('active', !show);
            redrawCanvas();
        }
        
        function saveCanvas() {
            const link = document.createElement('a');
            link.download = 'my-lifeline.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

    </script>
</body>
</html>
